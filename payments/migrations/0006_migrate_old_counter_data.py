# Generated by Django 5.2.5 on 2025-12-12 18:12
# Data Migration: ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯

from django.db import migrations


def migrate_counter_data_forward(apps, schema_editor):
    """
    ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    
    Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„Ø­Ù‚Ù„ accepted_tasks_count ØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Database ÙÙŠ 0005
    Ø§Ù„Ø­Ù„: Ù†Ø¶Ø¹ Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ù†Ø·Ù‚ÙŠØ©
    
    Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©:
    - Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠÙÙ†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ â†’ Ù†ÙØªØ±Ø¶ Ø§Ø³ØªØ®Ø¯Ù… 0 Ù…Ù‡Ø§Ù… Ù…Ø¬Ø§Ù†ÙŠØ©
    - total_subscriptions = 0 (Ù„Ù… ÙŠØ´ØªØ±ÙƒÙˆØ§ Ø¨Ø¹Ø¯)
    """
    UserTaskCounter = apps.get_model('payments', 'UserTaskCounter')
    db_alias = schema_editor.connection.alias
    
    updated_count = 0
    
    print("\n" + "="*60)
    print("ğŸ”„ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ù…...")
    print("="*60 + "\n")
    
    # Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    all_counters = UserTaskCounter.objects.using(db_alias).all()
    total_counters = all_counters.count()
    
    if total_counters == 0:
        print("âš ï¸  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ (Database ÙØ§Ø±ØºØ©)")
        print("\n" + "="*60)
        return
    
    print(f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ ØªÙ‡ÙŠØ¦ØªÙ‡Ø§: {total_counters}\n")
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ø³Ø¬Ù„
    for counter in all_counters:
        try:
            # Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ… Ø­Ø°ÙÙ‡Ø§ØŒ Ù†Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ±
            # Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ø³ÙŠØ¨Ø¯Ø£ÙˆÙ† Ø¨Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ (5 Ù…Ù‡Ø§Ù… Ù…Ø¬Ø§Ù†ÙŠØ©)
            counter.free_tasks_used = 0  # ÙŠØ¨Ø¯Ø£ Ù…Ù† 0 (Ù„Ø¯ÙŠÙ‡ 5 Ù…Ù‡Ø§Ù… Ù…ØªØ§Ø­Ø©)
            counter.total_subscriptions = 0
            counter.save(using=db_alias)
            
            updated_count += 1
            
            # Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…
            if updated_count % 10 == 0 or updated_count == total_counters:
                print(f"âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© {updated_count}/{total_counters} Ø³Ø¬Ù„...")
            
            # ØªÙØ§ØµÙŠÙ„ Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ù„ÙŠÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            if updated_count <= 5:
                user_phone = counter.user.phone if hasattr(counter.user, 'phone') else f"User #{counter.user.id}"
                print(f"   â””â”€ {user_phone}: ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© â†’ 0/5 Ù…Ù‡Ø§Ù… Ù…Ø¬Ø§Ù†ÙŠØ© Ù…ØªØ§Ø­Ø©")
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³Ø¬Ù„ {counter.id}: {str(e)}")
            continue
    
    # Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    print("\n" + "="*60)
    print("âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø©!")
    print(f"   - ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­: {updated_count} Ø³Ø¬Ù„")
    print(f"   - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø§Ù„Ø¢Ù†: 5 Ù…Ù‡Ø§Ù… Ù…Ø¬Ø§Ù†ÙŠØ©")
    print("="*60 + "\n")


def migrate_counter_data_backward(apps, schema_editor):
    """
    Ø¹ÙƒØ³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ù„Ù„Ø£Ù…Ø§Ù† ÙÙ‚Ø· - Ù„Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ ØºØ§Ù„Ø¨Ø§Ù‹)
    """
    print("\nâš ï¸  Ø¹ÙƒØ³ Ø§Ù„ØªØ­ÙˆÙŠÙ„: Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ÙØ¹Ù„ÙŠØ©\n")
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('payments', '0005_remove_usertaskcounter_accepted_tasks_count_and_more'),
    ]

    operations = [
        migrations.RunPython(
            migrate_counter_data_forward,
            migrate_counter_data_backward
        ),
    ]